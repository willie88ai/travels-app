<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä½©ä½©é˜¿ç‘‹ã„Ÿå¹´æœ«å®œè˜­è¼•æ—…â¤ï¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@400;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif;
            background-color: #F5F5F0;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* ç·¨è¼¯æ¨¡å¼æ¨£å¼ */
        .edit-input {
            background: #fff;
            border: 2px solid #C66B3D;
            border-radius: 4px;
            padding: 2px 4px;
            width: 100%;
            color: #333;
            font-size: 0.9rem;
        }
        .edit-input-time { width: 60px; text-align: center; }

        /* ä¸Šå‚³è®€å–æ¢å‹•ç•« */
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #C66B3D;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'jp-black': '#2C2C2C',
                        'jp-gray': '#8E8E8E',
                        'jp-beige': '#F5F5F0',
                        'jp-accent': '#C66B3D',
                        'jp-green': '#5F7161',
                        'jp-blue': '#6D8494',
                    }
                }
            }
        }
    </script>
</head>
<body class="text-jp-black antialiased">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-jp-beige relative pb-24 shadow-2xl overflow-hidden">
        
        <header class="pt-10 pb-4 px-6 bg-white rounded-b-3xl shadow-sm sticky top-0 z-10">
            <div class="flex justify-between items-start">
                <div class="flex-1 mr-4">
                    <h1 class="text-xl font-bold tracking-widest text-jp-black leading-tight">
                        ä½©ä½©é˜¿ç‘‹ã„Ÿ<br>å¹´æœ«å®œè˜­è¼•æ—…â¤ï¸ 
                        <span v-if="isEditing" class="text-xs text-jp-accent animate-pulse block mt-1">(ç·¨è¼¯ä¸­)</span>
                    </h1>
                    <p class="text-[10px] text-jp-gray mt-1 tracking-wider">Dec 13 - 16, 2025</p>
                    
                    <p class="text-xs text-jp-accent mt-3 font-medium leading-relaxed border-l-2 border-jp-accent pl-2">
                        åˆä¸€èµ·åº¦éäº†ä¸€å¹´ï¼Œ<br>è®“æˆ‘å€‘åœ¨2025çµæŸå‰ï¼Œ<br>ä¾†ä¸€æ®µå……æ»¿æ„›çš„æ—…ç¨‹å§ï¼
                    </p>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    <div class="w-10 h-10 rounded-full bg-jp-green text-white flex items-center justify-center shadow-md">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div v-if="isLoading" class="text-xs text-gray-400"><i class="fas fa-sync fa-spin"></i></div>
                </div>
            </div>
            
            <div class="mt-4 flex items-center rounded-xl p-3 text-sm transition-colors duration-500" :class="weather.bgClass">
                <i :class="weather.icon" class="mr-3 text-lg transition-all duration-500"></i>
                <div class="flex-1">
                    <span class="block font-bold">å®œè˜­ç¾æ³ï¼š{{ weather.desc }} {{ weather.temp }}</span>
                    <span class="text-xs text-gray-500">{{ weather.rainProb }}</span>
                </div>
            </div>
        </header>

        <main class="p-4 space-y-4">
            
            <div v-if="currentTab === 'schedule'">
                <div class="flex space-x-2 overflow-x-auto no-scrollbar mb-4 pb-1">
                    <button 
                        v-for="(day, index) in tripData.days" 
                        :key="index"
                        @click="currentDay = index"
                        :class="currentDay === index ? 'bg-jp-black text-white shadow-lg' : 'bg-white text-gray-400'"
                        class="flex-shrink-0 px-5 py-3 rounded-2xl transition-all duration-300 flex flex-col items-center min-w-[80px]"
                    >
                        <span class="text-xs font-light">Day {{ index + 1 }}</span>
                        <span class="text-lg font-bold">{{ day.date }}</span>
                    </button>
                </div>

                <div v-if="tripData.days && tripData.days.length > 0" class="space-y-4 pb-20">
                    <div v-for="(item, idx) in tripData.days[currentDay].events" :key="idx" 
                         class="glass-card rounded-2xl p-5 relative overflow-hidden transition-all duration-200">
                        
                        <div class="absolute left-0 top-0 bottom-0 w-1" :class="getCategoryColor(item.type)"></div>

                        <button v-if="isEditing" @click="deleteEvent(currentDay, idx)" class="absolute right-2 top-2 text-red-400 p-2 z-20">
                            <i class="fas fa-trash-alt"></i>
                        </button>

                        <div class="flex justify-between items-start mb-2 pr-6">
                            <div class="flex items-center space-x-2 w-full">
                                <input v-if="isEditing" v-model="item.time" class="edit-input edit-input-time font-bold" placeholder="æ™‚é–“">
                                <span v-else class="px-2 py-1 rounded-md text-xs font-bold bg-gray-100 text-gray-600">{{ item.time }}</span>
                                
                                <select v-if="isEditing" v-model="item.categoryLabel" class="edit-input w-24 text-xs">
                                    <option>æ™¯é»</option><option>ç¾é£Ÿ</option><option>ä½å®¿</option><option>äº¤é€š</option><option>å¤œæ™¯</option><option>è³¼ç‰©</option>
                                </select>
                                <span v-else class="text-xs text-gray-400 border border-gray-200 px-1 rounded whitespace-nowrap">{{ item.categoryLabel }}</span>
                            </div>
                            <a v-if="!isEditing" :href="'https://www.google.com/maps/search/?api=1&query=' + item.location" target="_blank" 
                               class="text-jp-blue hover:bg-blue-50 p-2 rounded-full transition">
                                <i class="fas fa-location-arrow text-lg"></i>
                            </a>
                        </div>

                        <div class="mb-1 pr-4">
                            <input v-if="isEditing" v-model="item.title" class="edit-input font-bold text-lg mb-1" placeholder="è¡Œç¨‹æ¨™é¡Œ">
                            <h3 v-else class="text-lg font-bold mb-1">{{ item.title }}</h3>
                        </div>

                        <div class="mb-3 pr-4">
                            <input v-if="isEditing" v-model="item.location" class="edit-input text-sm mb-1" placeholder="åœ°é»(å°èˆªç”¨)">
                            <p v-else class="text-sm text-gray-500 mb-3 flex items-center">
                                <i class="fas fa-map-marker-alt text-xs mr-1 w-4 text-center"></i> {{ item.location }}
                            </p>
                        </div>

                        <div class="flex flex-wrap gap-2 mt-3 mb-2">
                            <span v-for="tag in item.tags" :key="tag.text" :class="getTagStyle(tag.type)" class="text-xs px-2 py-1 rounded-lg border flex items-center">
                                <i :class="tag.icon" class="mr-1"></i> {{ tag.text }}
                            </span>
                        </div>

                        <div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                            <textarea v-if="isEditing" v-model="item.note" class="edit-input text-xs" rows="2" placeholder="å‚™è¨»"></textarea>
                            <p v-else class="text-xs text-gray-500 leading-relaxed">
                                <i class="fas fa-info-circle text-jp-accent mr-1"></i> {{ item.note }}
                            </p>
                        </div>

                        <div class="mt-4 pt-2">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-xs font-bold text-gray-400"><i class="fas fa-photo-video mr-1"></i> å›æ†¶é›†</h4>
                                <label class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs transition flex items-center">
                                    <span v-if="uploadingId === item.id" class="loader mr-1"></span>
                                    <span v-else><i class="fas fa-plus mr-1"></i></span>
                                    æ–°å¢
                                    <input type="file" class="hidden" accept="image/*,video/*" @change="handleFileUpload($event, currentDay, idx)" :disabled="uploadingId === item.id">
                                </label>
                            </div>

                            <div v-if="item.media && item.media.length > 0" class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                                <div v-for="(media, mIdx) in item.media" :key="mIdx" class="relative flex-shrink-0 w-24 h-24 rounded-lg overflow-hidden bg-black group">
                                    
                                    <img v-if="media.type === 'image'" :src="media.url" class="w-full h-full object-cover" @click="openMedia(media.url, 'image')">
                                    
                                    <video v-if="media.type === 'video'" :src="media.url" class="w-full h-full object-cover opacity-80" @click="openMedia(media.url, 'video')"></video>
                                    <i v-if="media.type === 'video'" class="fas fa-play absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white text-xl pointer-events-none"></i>

                                    <button @click="deleteMedia(currentDay, idx, mIdx)" class="absolute top-0 right-0 bg-red-500 text-white w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">Ã—</button>
                                </div>
                            </div>
                            <div v-else class="text-[10px] text-gray-300 italic py-1">
                                å°šç„¡å›æ†¶ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•ä¸Šå‚³ã€‚
                            </div>
                        </div>

                    </div>
                    
                    <button v-if="isEditing" @click="addNewEvent(currentDay)" class="w-full py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold hover:bg-white hover:border-jp-accent hover:text-jp-accent transition">
                        <i class="fas fa-plus-circle mr-2"></i> æ–°å¢è¡Œç¨‹
                    </button>

                    <div class="h-10"></div>
                </div>
            </div>

            <div v-if="currentTab === 'budget'" class="pb-20">
                <div class="bg-white rounded-2xl p-6 shadow-sm mb-4 text-center">
                    <p class="text-sm text-gray-400 mb-1">ç¸½èŠ±è²» (TWD)</p>
                    <h2 class="text-4xl font-bold text-jp-black font-mono">{{ formatCurrency(totalBudget) }}</h2>
                </div>

                <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
                    <h3 class="text-sm font-bold mb-3 text-gray-600">æ–°å¢æ”¯å‡º (å…±åŒç·¨è¼¯)</h3>
                    <div class="flex space-x-2 mb-2">
                        <input v-model="newExpense.item" placeholder="é …ç›®" class="flex-1 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 ring-jp-green">
                        <input v-model="newExpense.amount" type="number" placeholder="$" class="w-24 bg-gray-50 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 ring-jp-green">
                    </div>
                    <button @click="addExpense" class="w-full bg-jp-black text-white rounded-lg py-2 text-sm font-bold active:bg-gray-700 transition">
                        <i class="fas fa-plus mr-1"></i> è¨˜ä¸€ç­†
                    </button>
                </div>

                <div class="space-y-2">
                    <div v-for="(expense, idx) in tripData.expenses" :key="idx" class="bg-white px-4 py-3 rounded-xl flex justify-between items-center shadow-sm">
                        <span class="text-sm font-medium">{{ expense.item }}</span>
                        <div class="flex items-center space-x-3">
                            <span class="font-mono font-bold text-jp-green">{{ formatCurrency(expense.amount) }}</span>
                            <button @click="removeExpense(idx)" class="text-gray-300 hover:text-red-400"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div v-if="!tripData.expenses || tripData.expenses.length === 0" class="text-center text-gray-400 text-xs py-8">
                        ç›®å‰é‚„æ²’æœ‰è¨˜å¸³å–”
                    </div>
                </div>
            </div>

        </main>

        <button v-if="currentTab === 'schedule'" @click="toggleEdit" 
                :class="isEditing ? 'bg-jp-accent rotate-0' : 'bg-jp-black'"
                class="fixed bottom-24 right-6 w-14 h-14 rounded-full text-white shadow-2xl flex items-center justify-center transition-all duration-300 z-50 text-xl">
            <i :class="isEditing ? 'fas fa-save' : 'fas fa-pen'"></i>
        </button>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-8 py-3 flex justify-around items-center z-50 max-w-md mx-auto rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
            <button @click="currentTab = 'schedule'" :class="currentTab === 'schedule' ? 'text-jp-black' : 'text-gray-300'" class="flex flex-col items-center transition">
                <i class="fas fa-map-marked-alt text-xl mb-1"></i>
                <span class="text-[10px] font-bold">è¡Œç¨‹</span>
            </button>
            <div class="w-px h-8 bg-gray-100"></div>
            <button @click="currentTab = 'budget'" :class="currentTab === 'budget' ? 'text-jp-black' : 'text-gray-300'" class="flex flex-col items-center transition">
                <i class="fas fa-calculator text-xl mb-1"></i>
                <span class="text-[10px] font-bold">è¨˜å¸³</span>
            </button>
        </nav>

        <div v-if="previewMedia.url" class="fixed inset-0 z-[60] bg-black bg-opacity-95 flex items-center justify-center p-4" @click="previewMedia = {}">
            <img v-if="previewMedia.type === 'image'" :src="previewMedia.url" class="max-w-full max-h-full rounded-lg">
            <video v-if="previewMedia.type === 'video'" :src="previewMedia.url" controls autoplay class="max-w-full max-h-full rounded-lg"></video>
            <button class="absolute top-4 right-4 text-white text-2xl">Ã—</button>
        </div>

    </div>

    <script>
        // ==========================================
        // ğŸ”¥ é‡è¦ï¼šè«‹åœ¨é€™è£¡å¡«å…¥ä½ çš„ Firebase Config
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAv9Q6XuB-XL8s5-p8_xU6iTHMpm9Toy5E",
            authDomain: "yilan-trip-c1069.firebaseapp.com",
            projectId: "yilan-trip-c1069",
            storageBucket: "yilan-trip-c1069.firebasestorage.app",
            messagingSenderId: "754631881000",
            appId: "1:754631881000:web:8d25bf3cad2e800557201d"
        };

        // åˆå§‹åŒ– Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const storage = firebase.storage();

        const { createApp } = Vue

        createApp({
            data() {
                return {
                    currentTab: 'schedule',
                    currentDay: 0,
                    isLoading: true,
                    isEditing: false,
                    uploadingId: null, // æ­£åœ¨ä¸Šå‚³çš„ Event ID
                    previewMedia: {}, // é è¦½åª’é«”
                    newExpense: { item: '', amount: '' },
                    weather: { temp: '--', desc: 'è¼‰å…¥ä¸­...', rainProb: '', icon: 'fas fa-spinner fa-spin text-gray-400', bgClass: 'bg-gray-50' },
                    
                    tripData: {
                        days: [],
                        expenses: []
                    },

                    // ğŸ”¥ é è¨­è¡Œç¨‹è³‡æ–™ (å®Œæ•´ä¿ç•™ï¼Œç‚ºäº†æ¸…æ¥šé–±è®€å·²å±•é–‹)
                    defaultDays: [
                        {
                            date: '12/13 (å…­)',
                            events: [
                                {
                                    id: 1,
                                    time: '10:30',
                                    type: 'spot',
                                    title: 'è˜­é™½å‹•æ¤ç‰©ç‹åœ‹',
                                    location: 'è˜­é™½å‹•æ¤ç‰©ç‹åœ‹',
                                    categoryLabel: 'æ™¯é»',
                                    tags: [{type: 'highlight', text: 'æ°´è±šäº’å‹•', icon: 'fas fa-paw'}],
                                    note: 'ç¬¬ä¸€ç«™å…ˆä¾†ç™‚ç™’ä¸€ä¸‹ï¼',
                                    media: []
                                },
                                {
                                    id: 2,
                                    time: '14:00',
                                    type: 'stay',
                                    title: 'æ—¥å…‰ç¶ ç¯‰ Check-in',
                                    location: 'æ—¥å…‰ç¶ ç¯‰ LOHERB',
                                    categoryLabel: 'ä½å®¿',
                                    tags: [{type: 'chill', text: 'ç”Ÿæ…‹æ± ä¸‹åˆèŒ¶', icon: 'fas fa-coffee'}],
                                    note: 'äº«å—æ¸¡å‡æ°›åœï¼Œè¶å¤©äº®æ‹ç¾ç…§ã€‚',
                                    media: []
                                },
                                {
                                    id: 3,
                                    time: '16:30',
                                    type: 'spot',
                                    title: 'å†¬å±±æ²³ç”Ÿæ…‹ç¶ èˆŸ',
                                    location: 'å†¬å±±æ²³ç”Ÿæ…‹ç¶ èˆŸ',
                                    categoryLabel: 'æ™¯é»',
                                    tags: [{type: 'highlight', text: 'ç¥ç§˜æ²³é“', icon: 'fas fa-star'}],
                                    note: 'å‚æ™šé»ç‡ˆå¾Œéå¸¸æµªæ¼«ã€‚',
                                    media: []
                                },
                                {
                                    id: 4,
                                    time: '18:00',
                                    type: 'food',
                                    title: 'é¦™å»šè‡­è±†è…',
                                    location: 'é¦™å»šç±³ç²‰ç¾¹',
                                    categoryLabel: 'å°åƒ',
                                    tags: [{type: 'food', text: 'æœ‰æ©Ÿç¶ è‡­è±†è…', icon: 'fas fa-utensils'}],
                                    note: 'åœ¨åœ°äººæ¨è–¦ï¼Œå¿…åƒè‡­è±†è…è·Ÿç±³ç²‰ç¾¹ã€‚',
                                    media: []
                                },
                                {
                                    id: 5,
                                    time: '19:30',
                                    type: 'food',
                                    title: 'ç¾…æ±å¤œå¸‚',
                                    location: 'ç¾…æ±å¤œå¸‚',
                                    categoryLabel: 'æ™šé¤',
                                    tags: [{type: 'food', text: 'é˜¿ç¶ä¼¯', icon: 'fas fa-utensils'}],
                                    note: 'äººå¤šå°å¿ƒéŒ¢åŒ…ï¼Œå»ºè­°åœç«‹é«”åœè»Šå ´ã€‚',
                                    media: []
                                }
                            ]
                        },
                        {
                            date: '12/14 (æ—¥)',
                            events: [
                                {
                                    id: 6,
                                    time: '08:00',
                                    type: 'trans',
                                    title: 'å‡ºç™¼å‰å¾€å¤ªå¹³å±±',
                                    location: 'å¤ªå¹³å±±åœ‹å®¶æ£®æ—éŠæ¨‚å€',
                                    categoryLabel: 'äº¤é€š',
                                    tags: [{type: 'warn', text: 'å®¹æ˜“æšˆè»Š', icon: 'fas fa-pills'}],
                                    note: 'è»Šç¨‹ 1.5hrï¼Œå±±è·¯èœ¿èœ’ã€‚',
                                    media: []
                                },
                                {
                                    id: 7,
                                    time: '09:30',
                                    type: 'spot',
                                    title: 'è¦‹æ™´æ‡·å¤æ­¥é“',
                                    location: 'è¦‹æ™´æ‡·å¤æ­¥é“',
                                    categoryLabel: 'æ™¯é»',
                                    tags: [{type: 'highlight', text: 'å…¨çƒæœ€ç¾å°è·¯', icon: 'fas fa-tree'}],
                                    note: 'éœ§æ°£é‡è¨˜å¾—ä¿æš–ã€‚',
                                    media: []
                                },
                                {
                                    id: 8,
                                    time: '14:30',
                                    type: 'spot',
                                    title: 'æ¸…æ°´åœ°ç†±å…¬åœ’',
                                    location: 'æ¸…æ°´åœ°ç†±å…¬åœ’',
                                    categoryLabel: 'é«”é©—',
                                    tags: [{type: 'food', text: 'ç…®æº«æ³‰è›‹', icon: 'fas fa-egg'}],
                                    note: 'è¨˜å¾—ç§Ÿç«¹ç°ï¼Œè‡ªå‚™æ¯›å·¾ã€‚',
                                    media: []
                                },
                                {
                                    id: 9,
                                    time: '18:30',
                                    type: 'food',
                                    title: 'å¾®ç¬‘é£Ÿå®¢',
                                    location: 'å¾®ç¬‘é£Ÿå®¢',
                                    categoryLabel: 'æ™šé¤',
                                    tags: [{type: 'highlight', text: 'åœ¨åœ°é£Ÿæç°¡é¤', icon: 'fas fa-utensils'}],
                                    note: 'å·²é å®šç›®æ¨™ï¼Œæ°£æ°›æº«é¦¨ã€‚',
                                    media: []
                                },
                                {
                                    id: 10,
                                    time: '20:30',
                                    type: 'spot',
                                    title: 'ç©ºã„Ÿè¾²å ´å¤œæ™¯',
                                    location: 'ç©ºã„Ÿè¾²å ´',
                                    categoryLabel: 'å¤œæ™¯',
                                    tags: [{type: 'photo', text: 'ç™¾è¬å¤œæ™¯', icon: 'fas fa-star'}],
                                    note: 'éœ€åœ¨å±±ä¸‹æ­ä¹˜æ¥é§è»Šä¸Šå±±ã€‚',
                                    media: []
                                }
                            ]
                        },
                        {
                            date: '12/15 (ä¸€)',
                            events: [
                                {
                                    id: 11,
                                    time: '12:00',
                                    type: 'food',
                                    title: 'å¡­åº•çƒ¤é­š',
                                    location: 'å¡­åº•çƒ¤é­š',
                                    categoryLabel: 'åˆé¤',
                                    tags: [{type: 'food', text: 'é¹½çƒ¤é­š', icon: 'fas fa-fish'}],
                                    note: 'é­šå¾ˆå¤§éš»ï¼Œå»ºè­°ææ—©è¨‚ä½ã€‚',
                                    media: []
                                },
                                {
                                    id: 12,
                                    time: '15:00',
                                    type: 'stay',
                                    title: 'å±±å½¢é–£ Check-in',
                                    location: 'ç¤æºªå±±å½¢é–£æº«æ³‰é£¯åº—',
                                    categoryLabel: 'ä½å®¿',
                                    tags: [{type: 'chill', text: 'æˆ¿å…§å¤§æ¹¯æ± ', icon: 'fas fa-bath'}],
                                    note: 'å…¥ä½å¾Œå°±å¾…åœ¨é£¯åº—äº«å—è¨­æ–½ï¼',
                                    media: []
                                },
                                {
                                    id: 13,
                                    time: '18:00',
                                    type: 'food',
                                    title: 'é£¯åº—æ™šé¤/ä¼‘æ¯',
                                    location: 'ç¤æºªå±±å½¢é–£æº«æ³‰é£¯åº—',
                                    categoryLabel: 'æ™šé¤',
                                    tags: [{type: 'chill', text: 'æ”¾é¬†', icon: 'fas fa-wine-glass'}],
                                    note: 'ä¸æƒ³å‡ºé–€å°±å«å¤–é€æˆ–åƒé£¯åº—ã€‚',
                                    media: []
                                }
                            ]
                        },
                        {
                            date: '12/16 (äºŒ)',
                            events: [
                                {
                                    id: 14,
                                    time: '09:00',
                                    type: 'food',
                                    title: 'é£¯åº—è±ªè¯æ—©é¤',
                                    location: 'ç¤æºªå±±å½¢é–£æº«æ³‰é£¯åº—',
                                    categoryLabel: 'æ—©é¤',
                                    tags: [{type: 'highlight', text: 'åŠè‡ªåŠ©å¼', icon: 'fas fa-coffee'}],
                                    note: 'æ…¢æ…¢äº«ç”¨è‡³11é»é€€æˆ¿ã€‚',
                                    media: []
                                },
                                {
                                    id: 15,
                                    time: '11:00',
                                    type: 'trans',
                                    title: 'é€€æˆ¿ & å‰å¾€å°ä¸­',
                                    location: 'å±‹é¦¬ç‡’è‚‰',
                                    categoryLabel: 'äº¤é€š',
                                    tags: [{type: 'info', text: 'é•·é€”è»Šç¨‹', icon: 'fas fa-car'}],
                                    note: 'ç›´å¥”å°ä¸­åƒç‡’è‚‰ï¼',
                                    media: []
                                },
                                {
                                    id: 16,
                                    time: '13:30',
                                    type: 'food',
                                    title: 'å±‹é¦¬ç‡’è‚‰',
                                    location: 'å±‹é¦¬ç‡’è‚‰',
                                    categoryLabel: 'åˆé¤',
                                    tags: [{type: 'highlight', text: 'é›æ¹¯å¿…å–', icon: 'fas fa-fire'}],
                                    note: 'å®Œç¾çš„æ—…ç¨‹Endingã€‚',
                                    media: []
                                }
                            ]
                        }
                    ]
                }
            },
            mounted() {
                this.fetchRealTimeWeather();
                this.initRealtimeSync();
            },
            computed: {
                totalBudget() {
                    if (!this.tripData.expenses) return 0;
                    return this.tripData.expenses.reduce((sum, item) => sum + parseInt(item.amount || 0), 0);
                }
            },
            methods: {
                // åˆå§‹åŒ–é›²ç«¯åŒæ­¥
                initRealtimeSync() {
                    const docRef = db.collection('trips').doc('yilan2025');
                    
                    docRef.onSnapshot((doc) => {
                        this.isLoading = false;
                        if (doc.exists) {
                            console.log("Sync Update");
                            this.tripData = doc.data();
                        } else {
                            // å¦‚æœé›²ç«¯æ²’è³‡æ–™ï¼Œå¯«å…¥é è¨­
                            this.tripData.days = this.defaultDays;
                            this.saveToCloud(); 
                        }
                    });
                },
                
                saveToCloud() {
                    db.collection('trips').doc('yilan2025').set(this.tripData)
                        .catch((error) => alert("å„²å­˜å¤±æ•—: " + error.message));
                },

                toggleEdit() {
                    if (this.isEditing) {
                        this.saveToCloud();
                    }
                    this.isEditing = !this.isEditing;
                },

                // ==========================
                // ğŸ”¥ æ–°å¢/åˆªé™¤è¡Œç¨‹åŠŸèƒ½
                // ==========================
                addNewEvent(dayIndex) {
                    const newId = Date.now();
                    this.tripData.days[dayIndex].events.push({
                        id: newId,
                        time: '12:00',
                        type: 'spot',
                        title: 'æ–°è¡Œç¨‹',
                        location: '',
                        categoryLabel: 'ä¸€èˆ¬',
                        tags: [],
                        note: '',
                        media: []
                    });
                    this.isEditing = true;
                    this.saveToCloud();
                },

                deleteEvent(dayIndex, eventIdx) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) {
                        this.tripData.days[dayIndex].events.splice(eventIdx, 1);
                        this.saveToCloud();
                    }
                },

                // ==========================
                // ğŸ“¸ åª’é«”ä¸Šå‚³åŠŸèƒ½
                // ==========================
                async handleFileUpload(event, dayIdx, eventIdx) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const eventItem = this.tripData.days[dayIdx].events[eventIdx];
                    this.uploadingId = eventItem.id;

                    try {
                        const storageRef = storage.ref(`trips/yilan2025/files/${Date.now()}_${file.name}`);
                        const snapshot = await storageRef.put(file);
                        const downloadURL = await snapshot.ref.getDownloadURL();

                        const type = file.type.startsWith('video') ? 'video' : 'image';

                        if (!eventItem.media) eventItem.media = [];
                        eventItem.media.push({
                            url: downloadURL,
                            type: type,
                            name: file.name
                        });

                        this.saveToCloud();

                    } catch (error) {
                        alert("ä¸Šå‚³å¤±æ•—ï¼š" + error.message);
                    } finally {
                        this.uploadingId = null;
                    }
                },

                deleteMedia(dayIdx, eventIdx, mediaIdx) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡/å½±ç‰‡å—ï¼Ÿ')) {
                        this.tripData.days[dayIdx].events[eventIdx].media.splice(mediaIdx, 1);
                        this.saveToCloud();
                    }
                },

                openMedia(url, type) {
                    this.previewMedia = { url, type };
                },

                // å…¶ä»–è¼”åŠ©åŠŸèƒ½
                async fetchRealTimeWeather() {
                    try {
                        const url = `https://api.open-meteo.com/v1/forecast?latitude=24.82&longitude=121.77&current=temperature_2m,weather_code,precipitation_probability&timezone=Asia%2FTaipei`;
                        const res = await fetch(url);
                        const data = await res.json();
                        const wmo = this.getWeatherInfo(data.current.weather_code);
                        this.weather = {
                            temp: Math.round(data.current.temperature_2m) + 'Â°C',
                            desc: wmo.desc,
                            rainProb: 'é™é›¨ ' + (data.current.precipitation_probability || 0) + '%',
                            icon: wmo.icon,
                            bgClass: wmo.bg
                        };
                    } catch (e) { console.error(e); }
                },

                addExpense() {
                    if (!this.newExpense.item || !this.newExpense.amount) return;
                    if (!this.tripData.expenses) this.tripData.expenses = [];
                    this.tripData.expenses.push({ ...this.newExpense });
                    this.newExpense.item = ''; this.newExpense.amount = '';
                    this.saveToCloud();
                },
                removeExpense(idx) {
                    this.tripData.expenses.splice(idx, 1);
                    this.saveToCloud();
                },
                
                // Styles & Helpers
                getWeatherInfo(code) {
                    if (code <= 3) return { desc: 'å¤šé›²', icon: 'fas fa-cloud-sun text-orange-400', bg: 'bg-orange-50' };
                    if (code >= 51) return { desc: 'æœ‰é›¨', icon: 'fas fa-cloud-rain text-blue-500', bg: 'bg-blue-50' };
                    return { desc: 'é™°å¤©', icon: 'fas fa-cloud text-gray-500', bg: 'bg-gray-50' };
                },
                getCategoryColor(type) {
                    const colors = { stay: 'bg-jp-blue', food: 'bg-jp-accent', spot: 'bg-jp-green', trans: 'bg-gray-400', shop: 'bg-yellow-500' };
                    return colors[type] || 'bg-gray-400';
                },
                getTagStyle(type) {
                    const styles = { highlight: 'bg-yellow-50 text-yellow-700', food: 'bg-orange-50 text-orange-700', chill: 'bg-teal-50 text-teal-700' };
                    return styles[type] || 'bg-gray-50 text-gray-600';
                },
                formatCurrency(val) { return '$' + val.toLocaleString(); }
            }
        }).mount('#app')
    </script>
</body>
</html>
